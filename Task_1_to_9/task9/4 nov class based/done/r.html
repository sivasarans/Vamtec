<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100 flex flex-col items-center">
    <div class="text-center mb-5">
        <h1 class="text-3xl font-bold mb-5">Registered Users</h1>
        <div class="flex justify-center gap-4 flex-wrap">
            <a href="c.html">
                <button class="bg-blue-500 text-white font-bold py-2 px-4 rounded hover:bg-blue-600 mb-4">Add Country</button>
            </a>
            <a href="s.html">
                <button class="bg-green-500 text-white font-bold py-2 px-4 rounded hover:bg-green-600 mb-4">Add State</button>
            </a>
        </div>
    </div>SELECT * FROM public."sample table"
ORDER BY "ID" ASC

    <div class="flex flex-col space-y-4 w-full max-w-4xl mx-auto p-4">
        <form id="formsubmit" class="bg-white p-6 rounded-lg shadow-md">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="name" class="block mt-2">User Name</label>
                    <input id="name" type="text" placeholder="Enter your name" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="organization" class="block mt-2">Organization</label>
                    <input id="organization" type="text" placeholder="Enter your organization" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="email" class="block mt-2">E-mail</label>
                    <input id="email" type="email" placeholder="Enter your email" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="password" class="block mt-2">Password</label>
                    <input id="password" type="password" placeholder="Enter your password" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="numUsers" class="block mt-2">Number of Users</label>
                    <input type="number" id="numUsers" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="mobile" class="block mt-2">Mobile Number</label>
                    <input id="mobile" placeholder="Enter Mobile" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="countrySelect" class="block mt-2">Select Country</label>
                    <select id="countrySelect" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Choose Country</option>
                    </select>
                </div>

                <div>
                    <label for="expireDays" class="block mt-2">Expire Days</label>
                    <input type="number" id="expireDays" class="mt-1 block w-full p-2 border border-green-200 rounded-md">
                </div>

                <div>
                    <label for="stateSelect" class="block mt-2">Select State</label>
                    <select id="stateSelect" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Choose State</option>
                    </select>
                </div>
                <div>
                    <label for="imageUpload" class="block mb-2">Upload Image:</label>
                    <input id="imageUpload" type="file" accept="image/*" class="block w-full mb-4 p-2 border border-gray-300 rounded-md">
                </div>

                <div class="col-span-full">
                    <button id="submit" type="submit" class="border border-green-200 text-black bg-purple-500 m-3 p-3 rounded-md w-full">Submit</button>
                </div>
            </div>
        </form>
    </div>

    <div class="w-full max-w-4xl mx-auto p-4">
        <h2 class="text-2xl font-bold mb-4">User List</h2>
        <table class="min-w-full bg-white border border-gray-300 rounded-lg overflow-hidden shadow-lg">
            <thead>
                <tr class="bg-gray-200">
                    <th class="py-3 px-4 border-b">ID</th>
                    <th class="py-3 px-4 border-b">Name</th>
                    <th class="py-3 px-4 border-b">Organization</th>
                    <th class="py-3 px-4 border-b">Mobile</th>
                    <th class="py-3 px-4 border-b">Email</th>
                    <th class="py-3 px-4 border-b">Num Users</th>
                    <th class="py-3 px-4 border-b">Country</th>
                    <th class="py-3 px-4 border-b">State</th>
                    <th class="py-3 px-4 border-b">Expiry</th>
                    <th class="py-3 px-4 border-b">Actions</th> <!-- Added Actions Column -->
                </tr>
            </thead>
            <tbody id="userTableBody">
                <!-- User data will populate here -->
            </tbody>
        </table>
    </div>

    <script>
        class UserRegistration {
            constructor() {
                this.dbName = "CountryDB";
                this.initDB();
                this.setupEventListeners();
            }

            initDB() {
                const request = indexedDB.open(this.dbName, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    db.createObjectStore("countries", { keyPath: "id" });
                    db.createObjectStore("states", { keyPath: "id" });
                    db.createObjectStore("Users_list", { keyPath: "id", autoIncrement: true });
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.loadCountries();
                    this.displayUsers(); // Load users on initialization
                };

                request.onerror = (event) => {
                    console.error("Database error: ", event.target.error);
                };
            }

            loadCountries() {
                const transaction = this.db.transaction(["countries"], "readonly");
                const objectStore = transaction.objectStore("countries");
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const countrySelect = document.getElementById("countrySelect");
                    event.target.result.forEach(country => {
                        const option = document.createElement("option");
                        option.value = country.id;
                        option.textContent = country.name;
                        countrySelect.appendChild(option);
                    });
                    console.log("Countries loaded successfully");
                };
            }

            setupEventListeners() {
                document.getElementById("countrySelect").addEventListener("change", (event) => {
                    this.loadStates(event.target.value);//means country id
                });

                document.getElementById("formsubmit").addEventListener("submit", (event) => {
                    event.preventDefault();
                    this.saveUserData();
                });
            }

            loadStates(countryId) {
                console.log(countryId); //3
                const transaction = this.db.transaction(["states"], "readonly");
                const objectStore = transaction.objectStore("states");
                const request = objectStore.getAll(); console.log(request);//all values in states table(id, name, etc.,)

                request.onsuccess = (event) => {console.log("onsuccess",event.target)
                    const stateSelect = document.getElementById("stateSelect");
                    stateSelect.innerHTML = '<option value="">Choose a state</option>'; // Reset state options
                    event.target.result
                        .filter(i => i.countryId === countryId)//table(countryId)===parameter(countryId)
                        .forEach(i => {
                            const option = document.createElement("option");
                            option.value = i.id;
                            option.textContent = i.name;
                            stateSelect.appendChild(option);
                        });console.log(event.target.result.filter(state => state.countryId === countryId));
                        console.log(event.target.result);
                    console.log("States updated successfully");
                };
            }


saveUserData() {
    const xxx = (id) => document.getElementById(id);
    const expireDays = parseInt(xxx("expireDays").value);
    const expiryDate = new Date(); //1731754555392 miili sec from 1970
    var zan=expiryDate.setDate(expiryDate.getDate() + expireDays);//2024-11-12T10:50:22.763Z.setDate(todaydate eg:20 + 7)=>1731754955868
    var zan=expiryDate.toISOString().split('T')[0]; //2024-11-12T10:50:22.763Z=> 1st index is 2024-11-12(y/m/d)
    var today = new Date();
    var formattedToday = today.toISOString().split('T')[0]; // Format today's date eg: 2024-11-01
    var diffInDays = Math.ceil((expiryDate - new Date(formattedToday)) / (1000 * 60 * 60 * 24));
    var daysLeft = diffInDays + " days left";
    var x_date= zan + " ( " + daysLeft + " ) "
    const userData = {
        name: xxx("name").value,
        organization: xxx("organization").value,
        email: xxx("email").value,
        numUsers: xxx("numUsers").value,
        password: xxx("password").value,
        mobile: xxx("mobile").value,
        countryId: xxx("countrySelect").value,
        country: xxx("countrySelect").options[xxx("countrySelect").selectedIndex].text,
        expiryDate: x_date,
        state: xxx("stateSelect").options[xxx("stateSelect").selectedIndex].text,
        diffDays:diffInDays,
    };

    // Check if form is valid before proceeding
    if (!this.validateForm()) return; // Stop execution if form is invalid

    const editingUserId = xxx("submit").getAttribute("data-edit-id");
    if (editingUserId) {
        userData.id = parseInt(editingUserId); // Add user ID to userData for updating
        this.updateUserData(userData);
    } else {
        this.addUserData(userData);
    }
    
}


validateForm() {
    let isValid = true;
    let missingFields = [];

    // List of mandatory fields
    const fields = ["name", "organization", "email", "countrySelect", "stateSelect", "numUsers", "expireDays"];
    fields.forEach(id => {
        if (!document.getElementById(id).value) {
            missingFields.push(id);
            isValid = false;
        }
    });

    // Validate mobile number separately for 10-digit requirement
    const mobile = document.getElementById("mobile").value;
    if (!/^\d{10}$/.test(mobile)) {
        missingFields.push("mobile (must be 10 digits)");
        isValid = false;
    }

    // Alert the user with a list of missing/invalid fields
    if (!isValid) {
        alert("Please fill in all required fields: " + missingFields.join(", "));
    }

    return isValid;
}



            addUserData(userData) {
                const transaction = this.db.transaction(["Users_list"], "readwrite");
                const objectStore = transaction.objectStore("Users_list");
                const request = objectStore.add(userData);

                request.onsuccess = () => {
                    this.clearForm();
                    this.displayUsers();
                };

                request.onerror = (event) => {
                    console.error("Error adding user data: ", event.target.error);
                };
            }

            updateUserData(userData) {
                const transaction = this.db.transaction(["Users_list"], "readwrite");
                const objectStore = transaction.objectStore("Users_list");
                const request = objectStore.put(userData); // Use put for updating

                request.onsuccess = () => {
                    this.clearForm();
                    this.displayUsers();
                };

                request.onerror = (event) => {
                    console.error("Error updating user data: ", event.target.error);
                };
            }

            clearForm() {
                document.getElementById("formsubmit").reset();
                document.getElementById("stateSelect").innerHTML = '<option value="">Choose a state</option>'; // Reset state options
                document.getElementById("submit").removeAttribute("data-edit-id"); // Clear edit ID
            }

            displayUsers() {
                const transaction = this.db.transaction(["Users_list"], "readonly");
                const objectStore = transaction.objectStore("Users_list");
                const request = objectStore.getAll();

                request.onsuccess = (event) => {
                    const users = event.target.result;
                    const userTableBody = document.getElementById("userTableBody");
                    userTableBody.innerHTML = ''; // Clear existing table rows

                    users.forEach(user => {
                        const row = document.createElement("tr");

const userRowClass = user.diffDays <= 3 ? 'bg-red-200' : ''; // Apply a red background if diffDays is less than 3

row.innerHTML = `
    <td class="py-3 px-4 border-b ${userRowClass}">${user.id}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.name}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.organization}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.mobile}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.email}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.numUsers}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.country}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.state}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">${user.expiryDate}</td>
    <td class="py-3 px-4 border-b ${userRowClass}">
        <button class="bg-yellow-500 text-white py-1 px-2 rounded edit-btn" data-id="${user.id}">Edit</button>
    </td>

`;

                        userTableBody.appendChild(row);
                    });
                    // <td class="py-2 px-4 border-b">
                    //             <button class="text-red-600" onclick="deleteUser(${user.id})">Delete</button>
                    //         </td>

                    this.setupEditButtons(); // Setup edit buttons after displaying users
                };
            }

            setupEditButtons() {
                const editButtons = document.querySelectorAll(".edit-btn");
                editButtons.forEach(button => {
                    button.addEventListener("click", (event) => {
                        const userId = parseInt(event.target.getAttribute("data-id"));
                        this.loadUserForEditing(userId);
                    });
                });
            }

            loadUserForEditing(userId) {
                const transaction = this.db.transaction(["Users_list"], "readonly");
                const objectStore = transaction.objectStore("Users_list");
                const request = objectStore.get(userId);

                request.onsuccess = (event) => {
                    const user = event.target.result;
                    if (user) {
                        document.getElementById("name").value = user.name;
                        document.getElementById("organization").value = user.organization;
                        document.getElementById("email").value = user.email;
                        document.getElementById("numUsers").value = user.numUsers;
                        document.getElementById("mobile").value = user.mobile;
                        document.getElementById("expireDays").value = user.expiryDate;
                        document.getElementById("countrySelect").value = user.countryId;
                        this.loadStates(user.countryId); // Load states for selected country
                        document.getElementById("stateSelect").value = user.state; // Set selected state
                        document.getElementById("submit").setAttribute("data-edit-id", userId); // Set edit ID for update
                    }
                };
            }
        }
        function deleteUser(userId) {
            const dbName = "CountryDB";
            const request = indexedDB.open(dbName, 1);

            request.onsuccess = (event) => {
                const db = event.target.result;
                const transaction = db.transaction(["Users_list"], "readwrite");
                const objectStore = transaction.objectStore("Users_list");
                const deleteRequest = objectStore.delete(userId);

                deleteRequest.onsuccess = () => {
                    console.log("User deleted successfully");
                    new UserRegistration().displayUsers(); // Refresh the user list
                };

                deleteRequest.onerror = (event) => {
                    console.error("Error deleting user: ", event.target.error);
                };
            };}

        document.addEventListener("DOMContentLoaded", () => {
            new UserRegistration();
        });
    </script>
</body>
</html>
